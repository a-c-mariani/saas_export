<?php
  defined('MOODLE_INTERNAL') || die();
  require_once($CFG->dirroot . '/report/saas_export/locallib.php');
  require_once($CFG->dirroot . '/report/saas_export/lib.php');
/*

$of_cursos = $DB->get_records('saas_ofertas_cursos', array('enable'=>1), 'name', 'uid, id, name, year, period');
$sql = "SELECT od.*
          FROM {saas_ofertas_cursos} oc
          JOIN {saas_ofertas_disciplinas} od ON (od.oferta_curso_uid = oc.uid AND od.enable = 1)
         WHERE oc.enable = 1
      ORDER BY oc.name, oc.year, oc.period, od.name";
$of_disciplinas = $DB->get_records_sql($sql);

print html_writer::start_tag('DIV', array('align'=>'center'));

if(empty($of_disciplinas)) {
    print $OUTPUT->box_start('generalbox boxwidthnormal');
    print $OUTPUT->heading(get_string('no_ofertas_disciplinas', 'report_saas_export'));
    print $OUTPUT->box_end();
} else {
    var_dump($of_cursos, $of_disciplinas);

}

print html_writer::end_tag('DIV');
*/
?>
  
<link rel="stylesheet" href="css/bootstrap.css" type="text/css">

<script src="js/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/app.js"></script>

<table class="table table-hover">

<th>SAAS</th>
<th>MOODLE</th>

<?php
  $saas = new saas();

  $ofertas = $saas->get_ofertas_disciplinas_salvas();
  $ofertas_mapeadas = $saas->get_ofertas_disciplinas_mapeadas();
  
  $ofertas_mapeadas_com_cursos = array();

  foreach ($ofertas_mapeadas as $key => $oferta_id) {
    $ofertas_mapeadas_com_cursos[$oferta_id] = $DB->get_records('saas_course_mapping', 
                           array('oferta_disciplina_id'=>$oferta_id), null, 'courseid');
  }
  
  $courses = $DB->get_records_menu('course', null, null, 'id, shortname');
  
  foreach ($ofertas as $oferta) {
    echo html_writer::start_tag('tr');
      
      echo html_writer::tag('td', $oferta->name);
      
      echo html_writer::start_tag('td');
        echo html_writer::start_tag('div');
            if (array_key_exists($oferta->uid, $ofertas_mapeadas_com_cursos)) {
              foreach ($ofertas_mapeadas_com_cursos[$oferta->uid] as $courseid => $object) {
                echo html_writer::start_tag('div', array('style'=>'float:left; margin-right:5px;'));
                  echo html_writer::tag('div', $courses[$courseid]);
                echo html_writer::end_tag('div');  
              }
              
              echo html_writer::start_tag('div');
                echo html_writer::tag('button', 'Adicionar', array('type'=>'button', 'id'=>$oferta->uid, 'class'=>'btn btn-default btn-xs moodle_map_many_to_one_bt'));
              echo html_writer::end_tag('div');
            
            } else {
              echo html_writer::start_tag('div');
                echo html_writer::tag('button', 'Mapear', array('type'=>'button', 'id'=>$oferta->uid, 'class'=>'btn btn-default btn-xs moodle_map_many_to_one_bt'));
              echo html_writer::end_tag('div');    
            }
        echo html_writer::end_tag('div');
      echo html_writer::end_tag('td');

    echo html_writer::end_tag('tr');
  }  
?>

</table>

<!-- Modal para Cursos Moodle-->
<div class="modal fade bs-example-modal-lg" id="cursos_moodle_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">Cursos Moodle</h4>
      </div>
        <?php require_once('locallib.php');
          build_tree_categories();
        ?>
      <div class="modal-footer">
        <button type="button" class="btn btn-default saas-bt-close" data-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>